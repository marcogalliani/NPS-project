---
title: "Data exploration"
---

Loading the data
```{r}
root = "../.."
source(paste(root,"include/utils.R",sep = "/"))

library(readr)
raw_merged_data <- read_csv(paste(root, "data/raw_merged_data.csv", sep="/"))
raw_merged_data$...1 <- NULL
```

## Data cleaning and preprocessing

### Missong data

We're "missing data" for 
- the election of the governors of 2016
- the election of the senators of 2016
- the election of the governors of 2014
- the election of the house representatives of 2016

Actually we're not really missing anything. This missing pattern is due to the rules used to vote in the US. For instance, at each election (1 time every 2 years) the 1/3 of the senate is renovated, thus just 1/3 of the counties are voting for the senators at each election. However, we can remove these variable, since are not of interest for our purpose.
```{r}
library(naniar)
library(ggplot2)

vis_miss(raw_merged_data, warn_large_data = FALSE)
gg_miss_var(raw_merged_data, show_pct = TRUE)

to_remove <- c("repgov16", "othergov16", "demgov16", 
               "repsen16", "othersen16", "demsen16", 
               "repgov14", "othergov14", "demgov14", 
               "rephouse16", "otherhouse16", "demhouse16"
               )
clean_data <- raw_merged_data[ ,!names(raw_merged_data) %in% to_remove]
```
We're missing context data for Oglala county in South Dakota, let's remove it 
```{r}
colSums(is.na(clean_data))
clean_data <- na.omit(clean_data)
```


### Compositions
Elections
```{r}
#2020
clean_data$gop_pct20 <- clean_data$per_gop
clean_data$dem_pct20 <- clean_data$per_dem
clean_data$others_pct20 <- 1 - clean_data$gop_pct20 - clean_data$dem_pct20

clean_data$total_votes20 <- clean_data$total_votes

clean_data$total_votes <- NULL
clean_data$per_gop <- NULL
clean_data$per_dem <- NULL

#2016
clean_data$total_votes16 <- clean_data$trump16 + clean_data$clinton16 + clean_data$otherpres16

clean_data$gop_pct16 <- clean_data$trump16/clean_data$total_votes16
clean_data$dem_pct16 <- clean_data$clinton16/clean_data$total_votes16
clean_data$others_pct16 <- clean_data$otherpres16/clean_data$total_votes16

#2012
clean_data$total_votes12 <- clean_data$romney12 + clean_data$obama12 + clean_data$otherpres12

clean_data$gop_pct12 <- clean_data$romney12/clean_data$total_votes12
clean_data$dem_pct12 <- clean_data$obama12/clean_data$total_votes12
clean_data$others_pct12 <- clean_data$otherpres12/clean_data$total_votes12
```

Age composition
```{r}
clean_data$age30to64 <- 100 - rowSums(clean_data[ ,c("age29andunder_pct", "age65andolder_pct")])
```

Gender composition
```{r}
clean_data$male_pct <- 100 - rowSums(clean_data[ ,c("female_pct")])
```

Ethnic composition
```{r}
clean_data$otherrace_pct <- 100 - rowSums(clean_data[,c("white_pct", "black_pct", "hispanic_pct")])
```

Educational composition
```{r}
clean_data$onlyhs_pct <- clean_data$lesscollege_pct - clean_data$lesshs_pct
clean_data$morecollege_pct <- 100 - clean_data$lesscollege_pct

clean_data$lesscollege_pct <- NULL
```

```{r}
clean_data$onlyhs_whites_pct <- 
  clean_data$lesscollege_whites_pct - clean_data$lesshs_whites_pct
clean_data$morecollege_whites_pct <- 100 - clean_data$lesscollege_whites_pct

clean_data$lesscollege_whites_pct <- NULL
```

Unemployment composition
```{r}
clean_data$clf_employed_pct <- 100 - clean_data$clf_unemploy_pct 
```

Writing the data
```{r}
clean_data <- na.omit(clean_data)
```

```{r}
write.csv(clean_data, file = paste(root, "data/clean_merged_data.csv", sep = "/"))
```


## Preliminary exploration
By means of some maps
```{r}
devtools::install_github("UrbanInstitute/urbnmapr")
```

```{r}
library(tidyverse)
library(urbnmapr)

considered_counties <- counties[!counties$state_name=="Alaska", ]
household_data <- left_join(clean_data, considered_counties, by = "county_fips") 
```

### Elections results
```{r}
library(RColorBrewer)

plot.electoral_results <- list()

plot.electoral_results$rep_vs_dem12 <- 
    household_data %>%
      ggplot(aes(long, lat, group = group, 
                 fill = gop_pct12/(gop_pct12+dem_pct12)
                 )) +
      geom_polygon(color = NA) +
      coord_map(projection = "mercator") +
      labs(fill = "GOP %") +
      scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0.5, limits=c(0,1))+
      ggtitle("2012 Presidential Election")

plot.electoral_results$rep_vs_dem16 <- 
    household_data %>%
      ggplot(aes(long, lat, group = group, 
                 fill = gop_pct16/(gop_pct16+dem_pct16)
                 )) +
      geom_polygon(color = NA) +
      coord_map(projection = "mercator") +
      labs(fill = "GOP %") +
      scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0.5, limits=c(0,1))+
      ggtitle("2016 Presidential Election")

plot.electoral_results$rep_vs_dem20 <- 
  household_data %>%
    ggplot(aes(long, lat, group = group, 
               fill = gop_pct20/(gop_pct20+dem_pct20)
               )) +
    geom_polygon(color = NA) +
    coord_map(projection = "mercator") +
    labs(fill = "GOP %") +
    scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0.5, limits=c(0,1))+
    ggtitle("2020 Presidential Election")

print(plot.electoral_results$rep_vs_dem12)
print(plot.electoral_results$rep_vs_dem16)
print(plot.electoral_results$rep_vs_dem20)
```


```{r}
ggsave(filename = "plots/rep_vs_dem12.png", plot = plot.electoral_results$rep_vs_dem12,
       width = 12, height = 7)
ggsave(filename = "plots/rep_vs_dem16.png", plot = plot.electoral_results$rep_vs_dem16,
       width = 12, height = 7)
ggsave(filename = "plots/rep_vs_dem20.png", plot = plot.electoral_results$rep_vs_dem20,
       width = 12, height = 7)
```


```{r}
library(RColorBrewer)

for(year in names(var_groups$elections)){
  
  rep_pct <- var_groups$elections[[year]][1]
  dem_pct <- var_groups$elections[[year]][2]
  other_pct <- var_groups$elections[[year]][3]
  
  
  print(
    household_data %>%
      ggplot(aes(long, lat, group = group, 
                 fill = eval(parse(text = rep_pct))/(eval(parse(text = rep_pct))+eval(parse(text = dem_pct)))
                 )) +
      geom_polygon(color = NA) +
      coord_map(projection = "mercator") +
      labs(fill = year) +
      scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0.5, limits=c(0,1)) + 
      ggtitle("Republicans vs Democrats")
  )
  
  print(
    household_data %>%
      ggplot(aes(long, lat, group = group, fill = eval(parse(text = other_pct)))) +
      geom_polygon(color = NA) +
      coord_map(projection = "mercator") +
      labs(fill = year) +
      scale_fill_gradient2(low = "white", high = "orange") +
      ggtitle("Other parties result")
  )
}
```

### Demographics

#### Population
```{r}
print(
    household_data %>%
      subset(POPULATION < 1e6) %>%
      ggplot(aes(long, lat, group = group, fill = POPULATION)) +
      geom_polygon(color = NA) +
      coord_map(projection = "mercator") +
      labs(fill = "population") +
      scale_fill_gradient2(low = "white", high = "green")
)
```

#### Race
```{r}
for(race_group in var_groups$demographics$race_composit[1:4]){
  print(
    household_data %>%
    ggplot(aes(long, lat, group = group, fill = eval(parse(text = race_group)))) +
    geom_polygon(color = NA) +
    coord_map(projection = "mercator") +
    labs(fill = race_group) +
    scale_fill_gradient2(low = "white", high = "red")
  )
}
```

#### Economic situation
```{r}
for(econ_var in var_groups$demographics$economic_situation){
  print(
    household_data %>%
    ggplot(aes(long, lat, group = group, fill = eval(parse(text = econ_var)))) +
    geom_polygon(color = NA) +
    coord_map(projection = "mercator") +
    labs(fill = econ_var) +
    scale_fill_gradient2(low = "white", high = "red")
  )
}
```
#### Education
```{r}
for(ed_var in var_groups$demographics$education){
  print(
    household_data %>%
    ggplot(aes(long, lat, group = group, fill = eval(parse(text = ed_var)))) +
    geom_polygon(color = NA) +
    coord_map(projection = "mercator") +
    labs(fill = ed_var) +
    scale_fill_gradient2(low = "white", high = "red")
  )
}
```


